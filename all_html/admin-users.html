<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Пользователи — админ</title>
    <link rel="stylesheet" href="/all_css/profile.css">
    <style>
        .admin-container { max-width: 1100px; margin: 40px auto; color:#fff }
        .admin-card { background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.2); }
        th { color:#A0E7FF; }
        .avatar-small { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid #FF6BFF; }
        .actions { display:flex; gap:8px; align-items:center }
        .top-actions { display:flex; justify-content: space-between; align-items:center; margin-bottom: 12px; }
        .profile-btn.inline { width:auto; padding:8px 12px }
        select { background: rgba(0,0,0,0.3); color:#fff; border:1px solid rgba(255,255,255,0.3); border-radius:6px; padding:6px }
        input[type=file] { display:none }
    </style>
    <link rel="stylesheet" href="/all_css/home.css">
    <link rel="stylesheet" href="/all_css/catalog.css">
    <link rel="stylesheet" href="/all_css/cart.css">
    <link rel="stylesheet" href="/all_css/bookmarks.css">
</head>
<body>
    <div class="admin-container">
        <div class="admin-card">
            <div class="top-actions">
                <h2>Управление пользователями</h2>
                <div>
                    <button class="profile-btn inline" onclick="location.href='profile.html'">Назад в профиль</button>
                </div>
            </div>
            <div id="error" style="color:#ff9fb0; margin-bottom:10px; display:none"></div>
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Аватар</th>
                        <th>Псевдоним</th>
                        <th>Email</th>
                        <th>Дата регистрации</th>
                        <th>Роль</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = `${window.location.origin}/api/v1`;
        function authHeaders(json=true){
            const token = localStorage.getItem('token');
            const h = token ? { 'Authorization': `Bearer ${token}` } : {};
            if (json) h['Content-Type'] = 'application/json';
            return h;
        }
        function showError(msg){
            const el = document.getElementById('error');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(()=>{ el.style.display='none'; }, 4000);
        }

        async function ensureAdmin(){
            const res = await fetch(`${API_BASE}/me`, { headers: authHeaders() });
            if (!res.ok) {
                alert('Необходимо войти');
                window.location.href = 'index.html';
                return null;
            }
            const me = await res.json();
            if (!me.role || me.role.name !== 'administrator'){
                alert('Доступ только для администраторов');
                window.location.href = 'profile.html';
                return null;
            }
            return me;
        }

        async function loadRoles(){
            const res = await fetch(`${API_BASE}/admin/roles`, { headers: authHeaders() });
            if(!res.ok) throw new Error('Не удалось загрузить роли');
            return res.json();
        }

        function formatDate(iso){
            if(!iso) return '';
            const d = new Date(iso);
            return d.toLocaleDateString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric' });
        }

        function createRow(user, roles){
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${user.id}</td>
                <td>
                    <img class="avatar-small" id="avatar-${user.id}" src="${user.avatar_base64 ? user.avatar_base64 : '/images/eb43e2e34889c891b4f6e66f44aa0dff.jpg'}" alt="avatar">
                    <input type="file" id="file-${user.id}" accept="image/*" />
                </td>
                <td>${user.username}</td>
                <td>${user.email}</td>
                <td>${formatDate(user.created_at)}</td>
                <td>
                    <select id="role-${user.id}">
                        ${roles.map(r => `<option value="${r.name}" ${user.role && user.role.name===r.name?'selected':''}>${r.name==='administrator'?'Администратор':'Пользователь'}</option>`).join('')}
                    </select>
                </td>
                <td class="actions">
                    <button class="profile-btn inline" id="save-role-${user.id}">Сохранить роль</button>
                    <button class="profile-btn inline" id="save-avatar-${user.id}">Сохранить аватар</button>
                </td>
            `;

            const fileInput = tr.querySelector(`#file-${user.id}`);
            const saveAvatarBtn = tr.querySelector(`#save-avatar-${user.id}`);
            const avatarImg = tr.querySelector(`#avatar-${user.id}`);
            let avatarBase64 = null;
            fileInput.addEventListener('change', () => {
                const file = fileInput.files && fileInput.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = () => { avatarBase64 = reader.result; };
                reader.readAsDataURL(file);
            });
            saveAvatarBtn.addEventListener('click', async () => {
                if(!avatarBase64){ alert('Выберите файл'); return; }
                try{
                    const res = await fetch(`${API_BASE}/admin/users/${user.id}/avatar`, {
                        method: 'PUT',
                        headers: authHeaders(true),
                        body: JSON.stringify({ avatar_base64: avatarBase64 })
                    });
                    const data = await res.json();
                    if(!res.ok) throw new Error(data.detail || 'Ошибка обновления аватара');
                    avatarImg.src = data.avatar_base64 || avatarImg.src;
                    avatarBase64 = null;
                    fileInput.value = '';
                }catch(e){ showError(e.message); }
            });

            const roleSelect = tr.querySelector(`#role-${user.id}`);
            const saveRoleBtn = tr.querySelector(`#save-role-${user.id}`);
            saveRoleBtn.addEventListener('click', async () => {
                const roleName = roleSelect.value;
                try{
                    const res = await fetch(`${API_BASE}/admin/users/${user.id}/role`, {
                        method: 'PUT',
                        headers: authHeaders(true),
                        body: JSON.stringify({ role_name: roleName })
                    });
                    const data = await res.json();
                    if(!res.ok) throw new Error(data.detail || 'Ошибка обновления роли');
                }catch(e){ showError(e.message); }
            });

            return tr;
        }

        (async function init(){
            const me = await ensureAdmin();
            if(!me) return;
            try{
                const [roles, users] = await Promise.all([
                    loadRoles(),
                    fetch(`${API_BASE}/admin/users`, { headers: authHeaders() }).then(r=>r.json())
                ]);
                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = '';
                users.forEach(u => tbody.appendChild(createRow(u, roles)));
            }catch(e){ showError(e.message || 'Ошибка загрузки'); }
        })();
    </script>
</body>
</html>
