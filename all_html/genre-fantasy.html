<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–§—ç–Ω—Ç–µ–∑–∏</title>
    <link rel="stylesheet" href="/all_css/catalog.css">
</head>
<body>
    <div class="container">
        <h1>–§—ç–Ω—Ç–µ–∑–∏</h1>
        <div id="moviesGrid" class="movies-grid"></div>
    </div>
    <div class="container">
        <div class="menu-buttons">
            <button class="menu-btn" onclick="location.href='catalog.html'">–ù–∞–∑–∞–¥</button>
            <button class="menu-btn" onclick="location.href='home.html'">–ì–ª–∞–≤–Ω–∞—è üè†</button>
            <button class="menu-btn" onclick="location.href='cart.html'">–ö–æ—Ä–∑–∏–Ω–∞ üõí</button>
            <button class="menu-btn" onclick="location.href='bookmarks.html'">–ó–∞–∫–ª–∞–¥–∫–∏ üîñ</button>
            <button class="menu-btn" onclick="location.href='profile.html'">–ü—Ä–æ—Ñ–∏–ª—å üöπ</button>
        </div>
    </div>
    <script src="/app.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const grid = document.getElementById('moviesGrid');
        const token = localStorage.getItem('token');
        let isAdmin = false;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
        if (token) {
            try {
                const res = await fetch(`${window.location.origin}/api/v1/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (res.ok) {
                    const data = await res.json();
                    isAdmin = data.role && data.role.name === 'administrator';
                }
            } catch (e) {
                console.error('Error checking admin status:', e);
            }
        }

        fetch(`/api/v1/genres/fantasy/films`).then(r=>r.json()).then(films=>{
            grid.innerHTML = films.map(f => `
            <div class=\"movie-card\" data-id=\"${f.flim_id}\">
                ${f.movie_base64 ? `<img src=\"${f.movie_base64}\" alt=\"${f.title_ru || f.title}\">` : ''}
                <div class=\"movie-info\">
                    <div class=\"movie-title\">${f.title_ru || f.title}</div>
                    <div class=\"movie-author\">${f.author || ''}</div>
                    <div class=\"movie-price\">${f.price ? `${f.price} ‚ÇΩ/—à—Ç` : ''}</div>
                    <div class=\"movie-buttons\">
                        <div class=\"bookmark-cart-container\" style=\"display: flex; gap: 10px;\">
                            <button class=\"movie-btn bookmark-btn\" style=\"flex: 1;\">üè∑Ô∏è</button>
                            <button class=\"movie-btn cart-btn\" style=\"flex: 1;\">üõí</button>
                        </div>
                        ${isAdmin ? `<button class=\"movie-btn delete-btn\" style=\"background: #dc3545; margin-top: 10px; width: 100%;\" onclick=\"deleteMovie(${f.flim_id})\">–£–¥–∞–ª–∏—Ç—å —Ñ–∏–ª—å–º</button>` : ''}
                    </div>
                </div>
            </div>`).join('');
        });
    });

    async function deleteMovie(filmId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∏–ª—å–º?')) return;
        
        const token = localStorage.getItem('token');
        try {
            const res = await fetch(`${window.location.origin}/api/v1/admin/films/${filmId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (res.ok) {
                alert('–§–∏–ª—å–º —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                location.reload();
            } else {
                const error = await res.text();
                alert('–û—à–∏–±–∫–∞: ' + error);
            }
        } catch (err) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∏–ª—å–º–∞: ' + err.message);
        }
    }
    </script>
</body>
</html>