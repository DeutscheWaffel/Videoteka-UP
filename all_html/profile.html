<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–æ—Ñ–∏–ª—å</title>
    <link rel="stylesheet" href="/all_css/profile.css">
</head>
<body>
    <div class="container">
        <div class="profile-card">
            <div class="profile-header">
                <img id="avatarImg" src="/images/eb43e2e34889c891b4f6e66f44aa0dff.jpg" alt="–ê–≤–∞—Ç–∞—Ä" class="avatar" style="cursor:pointer">
                <input id="avatarInput" type="file" accept="image/*" style="display:none" />
                <h2 id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                <p id="userRole">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>

            <div class="profile-info">
                <div class="info-item">
                    <label>Email:</label>
                    <span id="email">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <div class="info-item">
                    <label>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</label>
                    <span id="registrationDate">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
            </div>

            <div class="profile-actions">
                <button class="profile-btn change-pass-btn">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                <button class="profile-btn logout-btn">–í—ã–π—Ç–∏</button>
            </div>
        </div>

        <div class="menu-buttons">
            <button class="menu-btn" onclick="location.href='home.html'">–ì–ª–∞–≤–Ω–∞—è üè†</button>
            <button class="menu-btn" onclick="location.href='catalog.html'">–ö–∞—Ç–∞–ª–æ–≥ üìí</button>
            <button class="menu-btn" onclick="location.href='cart.html'">–ö–æ—Ä–∑–∏–Ω–∞ üõí</button>
            <button class="menu-btn" onclick="location.href='bookmarks.html'">–ó–∞–∫–ª–∞–¥–∫–∏ üîñ</button>
            <button class="menu-btn" onclick="location.href='profile.html'">–ü—Ä–æ—Ñ–∏–ª—å üöπ</button>
        </div>
    </div>

    <script>
        document.querySelector('.logout-btn').addEventListener('click', function () {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                // –°–±—Ä–æ—Å–∏–º –∫–æ—Ä–∑–∏–Ω—É, –∑–∞–∫–ª–∞–¥–∫–∏ –∏ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                localStorage.removeItem('cart');
                localStorage.removeItem('bookmarks');
                localStorage.removeItem('token');
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                window.location.href = 'index.html';
            }
        });

        const API_BASE = `${window.location.origin}/api/v1`;
        const avatarImg = document.getElementById('avatarImg');
        const avatarInput = document.getElementById('avatarInput');

        function authHeaders() {
            const token = localStorage.getItem('token');
            return token ? { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
        }

        avatarImg.addEventListener('click', () => avatarInput.click());

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        (async function checkAuthAndLoadProfile() {
            const token = localStorage.getItem('token');
            if (!token) {
                // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
                alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
                window.location.href = 'index.html';
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/me`, { headers: authHeaders() });
                if (!res.ok) {
                    if (res.status === 401) {
                        // –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω, —É–¥–∞–ª—è–µ–º –µ–≥–æ –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
                        localStorage.removeItem('token');
                        alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ.');
                        window.location.href = 'index.html';
                        return;
                    }
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è');
                }
                const data = await res.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                document.getElementById('username').textContent = data.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º email
                document.getElementById('email').textContent = data.email || '–ù–µ —É–∫–∞–∑–∞–Ω';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                if (data.created_at) {
                    const date = new Date(data.created_at);
                    const formattedDate = date.toLocaleDateString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                    document.getElementById('registrationDate').textContent = formattedDate;
                } else {
                    document.getElementById('registrationDate').textContent = '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å
                if (data.avatar_base64) {
                    avatarImg.src = data.avatar_base64;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (data.role) {
                    const roleText = data.role.name === 'administrator' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                    document.getElementById('userRole').textContent = roleText;
                } else {
                    document.getElementById('userRole').textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                document.getElementById('username').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                document.getElementById('email').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                document.getElementById('registrationDate').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                document.getElementById('userRole').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            }
        })();

        avatarInput.addEventListener('change', function () {
            const file = this.files && this.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function () {
                const base64 = reader.result;
                // –ù–µ–º–Ω–æ–≥–æ –∑–∞—â–∏—Ç–∏–º—Å—è: –æ–≥—Ä–∞–Ω–∏—á–∏–º —Ä–∞–∑–º–µ—Ä ~3.5 –ú–ë
                if (typeof base64 === 'string' && base64.length > 4_000_000) {
                    alert('–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª');
                    return;
                }
                try {
                    const res = await fetch(`${API_BASE}/me/avatar`, {
                        method: 'PUT',
                        headers: authHeaders(),
                        body: JSON.stringify({ avatar_base64: base64 })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error((data && (data.detail || data.message)) || '–û—à–∏–±–∫–∞');
                    if (data && data.avatar_base64) {
                        avatarImg.src = data.avatar_base64;
                    }
                } catch (e) {
                    alert(e.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∞–≤–∞—Ç–∞—Ä');
                }
            };
            reader.readAsDataURL(file);
        });

        // –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è
        document.querySelector('.change-pass-btn').addEventListener('click', async function () {
            const currentPassword = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å:');
            if (currentPassword === null) return;
            const newPassword = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤):');
            if (newPassword === null) return;
            try {
                const res = await fetch(`${API_BASE}/me/password`, {
                    method: 'PUT',
                    headers: authHeaders(),
                    body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
                });
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å');
                }
                alert('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω');
            } catch (e) {
                alert(e.message || '–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è');
            }
        });
    </script>
</body>
</html>